# GitLab CI/CD Pipeline for Job Mapping E2E Tests
# Documentation: https://docs.gitlab.com/ee/ci/

# Define pipeline stages
stages:
  - prepare
  - test
  - report
  - notify

# Global variables
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  JAVA_VERSION: "17"
  MAVEN_VERSION: "3.9.5"
  # Test configuration
  TEST_SUITE: "smoke_tests.xml"
  BROWSER: "chrome"
  ENVIRONMENT: "qa"
  HEADLESS_MODE: "true"
  PARALLEL_EXECUTION: "false"

# Cache Maven dependencies
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository/
    - e2e-automation/target/

# Docker image with Java and browsers pre-installed
image: selenium/standalone-chrome:latest

# Template for test execution
.test_template: &test_template
  stage: test
  before_script:
    - echo "ğŸ”§ Setting up test environment..."
    - java -version
    - mvn -version
    - cd e2e-automation
    - mvn clean
    - mkdir -p test-output/ExtentReports test-output/screenshots ExcelReports logs JobCatalogBackups
  script:
    - echo "ğŸš€ Executing E2E Tests..."
    - |
      MVN_CMD="mvn test -DsuiteXmlFile=${TEST_SUITE} -Dbrowser=${BROWSER} -Denvironment=${ENVIRONMENT}"
      
      if [ "${HEADLESS_MODE}" = "true" ]; then
        MVN_CMD="${MVN_CMD} -Dheadless.mode=true"
      fi
      
      if [ "${PARALLEL_EXECUTION}" = "true" ]; then
        MVN_CMD="${MVN_CMD} -Dparallel=methods -DthreadCount=3"
      fi
      
      echo "ğŸ“ Maven Command: ${MVN_CMD}"
      ${MVN_CMD} || true
  after_script:
    - echo "ğŸ“Š Test execution completed"
  artifacts:
    when: always
    paths:
      - e2e-automation/test-output/ExtentReports/
      - e2e-automation/ExcelReports/
      - e2e-automation/test-output/screenshots/
      - e2e-automation/logs/
    reports:
      junit: e2e-automation/test-output/testng-results.xml
    expire_in: 30 days
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOB DEFINITIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Prepare stage: Validate and setup
validate:
  stage: prepare
  script:
    - echo "âœ… Validating Maven project..."
    - cd e2e-automation
    - mvn validate
  only:
    - branches
    - tags

# Smoke Tests (Chrome)
smoke_tests_chrome:
  <<: *test_template
  variables:
    TEST_SUITE: "smoke_tests.xml"
    BROWSER: "chrome"
    ENVIRONMENT: "qa"
    HEADLESS_MODE: "true"
  only:
    - main
    - develop
    - merge_requests

# Regression Tests (Chrome)
regression_tests_chrome:
  <<: *test_template
  variables:
    TEST_SUITE: "regression_tests.xml"
    BROWSER: "chrome"
    ENVIRONMENT: "qa"
    HEADLESS_MODE: "true"
  only:
    - main
    - schedules
  when: manual

# Cross-Browser Tests (Chrome + Firefox)
cross_browser_tests:
  stage: test
  image: selenium/standalone-chrome:latest
  parallel:
    matrix:
      - BROWSER: ["chrome", "firefox"]
  variables:
    TEST_SUITE: "smoke_tests.xml"
    ENVIRONMENT: "qa"
    HEADLESS_MODE: "true"
  before_script:
    - cd e2e-automation
    - mvn clean
    - mkdir -p test-output/ExtentReports test-output/screenshots ExcelReports logs
  script:
    - |
      echo "ğŸ§ª Running tests on ${BROWSER}..."
      mvn test -DsuiteXmlFile=${TEST_SUITE} -Dbrowser=${BROWSER} -Denvironment=${ENVIRONMENT} -Dheadless.mode=${HEADLESS_MODE} || true
  artifacts:
    when: always
    paths:
      - e2e-automation/test-output/ExtentReports/
      - e2e-automation/ExcelReports/
      - e2e-automation/test-output/screenshots/
    expire_in: 15 days
  only:
    - schedules
  when: manual

# Manual trigger for any environment
manual_test_execution:
  <<: *test_template
  variables:
    TEST_SUITE: "${CI_TEST_SUITE}"
    BROWSER: "${CI_BROWSER}"
    ENVIRONMENT: "${CI_ENVIRONMENT}"
    HEADLESS_MODE: "${CI_HEADLESS}"
  when: manual
  only:
    - branches

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REPORTING STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

generate_report_summary:
  stage: report
  image: alpine:latest
  dependencies:
    - smoke_tests_chrome
  script:
    - echo "ğŸ“Š Generating test report summary..."
    - |
      cat > test_summary.md << EOF
      # ğŸ§ª E2E Test Execution Summary
      
      **Pipeline ID:** ${CI_PIPELINE_ID}
      **Commit:** ${CI_COMMIT_SHORT_SHA}
      **Branch:** ${CI_COMMIT_REF_NAME}
      **Test Suite:** ${TEST_SUITE}
      **Browser:** ${BROWSER}
      **Environment:** ${ENVIRONMENT}
      
      ## ğŸ“‚ Available Reports
      - ExtentReports HTML
      - Excel Dashboard
      - Screenshots (on failure)
      - Execution Logs
      
      ## ğŸ”— Links
      - [Pipeline Details](${CI_PIPELINE_URL})
      - [Commit Details](${CI_PROJECT_URL}/-/commit/${CI_COMMIT_SHA})
      EOF
    - cat test_summary.md
  artifacts:
    paths:
      - test_summary.md
    expire_in: 7 days
  only:
    - main
    - develop

# Pages: Publish HTML reports to GitLab Pages
pages:
  stage: report
  dependencies:
    - smoke_tests_chrome
  script:
    - mkdir -p public
    - cp -r e2e-automation/test-output/ExtentReports/* public/ || true
    - cp -r e2e-automation/ExcelReports public/ || true
    - |
      cat > public/index.html << EOF
      <!DOCTYPE html>
      <html>
      <head>
        <title>Job Mapping E2E Test Reports</title>
        <style>
          body { font-family: Arial; padding: 20px; background: #f5f5f5; }
          .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
          h1 { color: #333; }
          .report-link { display: block; padding: 15px; margin: 10px 0; background: #007bff; color: white; text-decoration: none; border-radius: 5px; text-align: center; }
          .report-link:hover { background: #0056b3; }
        </style>
      </head>
      <body>
        <div class="container">
          <h1>ğŸ“Š Job Mapping E2E Test Reports</h1>
          <p><strong>Pipeline:</strong> ${CI_PIPELINE_ID}</p>
          <p><strong>Branch:</strong> ${CI_COMMIT_REF_NAME}</p>
          <p><strong>Commit:</strong> ${CI_COMMIT_SHORT_SHA}</p>
          <a href="ExtentReport.html" class="report-link">ğŸ“ˆ View Extent Report</a>
          <a href="ExcelReports/" class="report-link">ğŸ“Š View Excel Reports</a>
        </div>
      </body>
      </html>
      EOF
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - main

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# NOTIFICATION STAGE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

notify_success:
  stage: notify
  image: alpine:latest
  script:
    - echo "âœ… Tests passed! Sending notification..."
    - |
      # Send Slack notification (requires SLACK_WEBHOOK_URL variable)
      if [ -n "${SLACK_WEBHOOK_URL}" ]; then
        apk add --no-cache curl
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"âœ… Job Mapping E2E Tests PASSED\n*Pipeline:* ${CI_PIPELINE_ID}\n*Branch:* ${CI_COMMIT_REF_NAME}\n*View:* ${CI_PIPELINE_URL}\"}" \
          ${SLACK_WEBHOOK_URL}
      fi
  only:
    - main
    - develop
  when: on_success

notify_failure:
  stage: notify
  image: alpine:latest
  script:
    - echo "âŒ Tests failed! Sending notification..."
    - |
      # Send Slack notification (requires SLACK_WEBHOOK_URL variable)
      if [ -n "${SLACK_WEBHOOK_URL}" ]; then
        apk add --no-cache curl
        curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"âŒ Job Mapping E2E Tests FAILED\n*Pipeline:* ${CI_PIPELINE_ID}\n*Branch:* ${CI_COMMIT_REF_NAME}\n*View:* ${CI_PIPELINE_URL}\"}" \
          ${SLACK_WEBHOOK_URL}
      fi
  only:
    - main
    - develop
  when: on_failure

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCHEDULED PIPELINES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Run nightly regression tests
# Schedule in GitLab: CI/CD > Schedules > New Schedule
# Cron: 0 2 * * * (Daily at 2 AM)

