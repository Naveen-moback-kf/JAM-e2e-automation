name: ğŸ§ª Job Mapping E2E Tests

run-name: |
  ${{ 
    github.event_name == 'schedule' && 
    'â° Scheduled Run | JAM_SmokeTestSuite.xml | chrome | qa' || 
    format('ğŸ“‹ {0} | {1} | {2}', github.event.inputs.test_suite, github.event.inputs.browser, github.event.inputs.environment)
  }}

on:
  # Automatic triggers disabled - Manual execution only
  # Uncomment below to re-enable automatic execution on push/PR
  # push:
  #   branches:
  #     - main
  #     - develop
  #     - 'release/**'
  # 
  # pull_request:
  #   branches:
  #     - main
  #     - develop
  
  # Manual trigger with parameters (ENABLED)
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ğŸ“‹ Test Suite to Execute'
        required: true
        default: 'JAM_SmokeTestSuite.xml'
        type: choice
        options:
          - JAM_SanityTestSuite.xml
          - JAM_SmokeTestSuite.xml
          - JAM_RegressionTestSuite.xml
      
      browser:
        description: 'Browser'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      
      environment:
        description: 'Test Environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod-eu
          - prod-us
      
      headless_mode:
        description: 'Run in Headless Mode'
        required: true
        default: true
        type: boolean
      
      parallel_execution:
        description: 'Enable Parallel Execution'
        required: false
        default: true
        type: boolean
      
      login_type:
        description: 'Login Type'
        required: true
        default: 'NON_SSO'
        type: choice
        options:
          - SSO
          - NON_SSO
      
      pams_id:
        description: 'Target PAMS ID (leave empty to verify all clients)'
        required: false
        default: '23139'
        type: string
      
      reset_excel_report:
        description: 'ğŸ”„ Reset Excel Report (Start Fresh)'
        required: false
        default: false
        type: boolean
      
      # Note: Username and password inputs removed due to GitHub's 10-input limit
      # All credentials are now sourced from GitHub Secrets (more secure)
      # Configure in: Settings > Secrets and variables > Actions
      # Required secrets: SSO_USERNAME, SSO_PASSWORD, NON_SSO_USERNAME, NON_SSO_PASSWORD
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“… SCHEDULED RUNS - CURRENTLY DISABLED (Manual execution only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # To enable: Uncomment "schedule:" and add cron expressions
  # Cron format: minute hour day_of_month month day_of_week (UTC timezone)
  # Examples: '0 2 * * *' (daily 2AM), '0 */6 * * *' (every 6hrs), '0 9 * * 1' (Mon 9AM)
  # Use https://crontab.guru/ to build custom schedules
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # schedule:
    # - cron: '0 2 * * *'  # Daily at 2:00 AM UTC

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.5'
  
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ğŸ“… SCHEDULED RUN CONFIGURATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Configure what runs automatically when triggered by schedule
  # These defaults are used ONLY for scheduled runs (cron triggers)
  # Manual runs via workflow_dispatch use the UI input selections
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SCHEDULED_TEST_SUITE: 'JAM_SmokeTestSuite.xml'    # Options: JAM_SanityTestSuite.xml, JAM_SmokeTestSuite.xml, JAM_RegressionTestSuite.xml
  SCHEDULED_BROWSER: 'chrome'                        # Options: chrome, firefox, edge
  SCHEDULED_ENVIRONMENT: 'qa'                        # Options: dev, qa, stage, prod-eu, prod-us
  SCHEDULED_HEADLESS: 'true'                         # Options: true, false
  SCHEDULED_LOGIN_TYPE: 'NON_SSO'                    # Options: SSO, NON_SSO
  SCHEDULED_PAMS_ID: '23139'                         # Target PAMS ID for scheduled runs
  SCHEDULED_RESET_EXCEL: 'false'                     # Options: true (start fresh), false (append to existing)

jobs:
  e2e-tests:
    name: ğŸ§ª E2E Tests - ${{ github.event_name == 'schedule' && 'â° Scheduled Run' || github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }} (${{ github.event.inputs.browser || 'chrome' }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # For parallel browser testing
        browser: [chrome]  # Add firefox, edge for multi-browser testing
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ğŸ”§ Setup Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}
      
      - name: ğŸŒ Setup Chrome Browser
        if: ${{ github.event.inputs.browser == 'chrome' || matrix.browser == 'chrome' }}
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: ğŸ¦Š Setup Firefox Browser
        if: ${{ github.event.inputs.browser == 'firefox' || matrix.browser == 'firefox' }}
        uses: browser-actions/setup-firefox@latest
        with:
          firefox-version: latest
      
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: ğŸ§¹ Clean Previous Build
        working-directory: e2e-automation
        run: mvn clean
      
      - name: ğŸ“ Create Report Directories
        run: |
          mkdir -p e2e-automation/AllureReports/allure-results
          mkdir -p e2e-automation/AllureReports/allure-report
          mkdir -p e2e-automation/test-output/screenshots
          mkdir -p e2e-automation/ExcelReports
          mkdir -p e2e-automation/logs
          mkdir -p e2e-automation/src/test/resources/JobCatalogBackups
      
      - name: ğŸ“¥ Download Previous Excel Report (if NOT resetting)
        if: ${{ github.event.inputs.reset_excel_report != 'true' && (github.event_name != 'schedule' || env.SCHEDULED_RESET_EXCEL != 'true') }}
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: jobmapping_e2e_tests.yml
          name_is_regexp: true
          name: ^excel-reports_.*
          path: e2e-automation/ExcelReports/
          if_no_artifact_found: ignore
          search_artifacts: true
          workflow_conclusion: ""
          check_artifacts: true
      
      - name: âœ… Check for Existing Excel Report
        if: ${{ github.event.inputs.reset_excel_report != 'true' && (github.event_name != 'schedule' || env.SCHEDULED_RESET_EXCEL != 'true') }}
        run: |
          if [ -f "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx" ]; then
            echo "âœ… Found existing Excel report - will append new results to it"
            ls -lh e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx
          else
            echo "â„¹ï¸  No existing Excel report found - will create new one"
          fi
      
      - name: ğŸ”„ Reset Excel Report (Optional)
        if: ${{ github.event.inputs.reset_excel_report == 'true' || (github.event_name == 'schedule' && env.SCHEDULED_RESET_EXCEL == 'true') }}
        run: |
          echo "ğŸ”„ Resetting Excel Report - Starting with fresh data"
          
          # Check if Excel report exists
          if [ -f "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx" ]; then
            echo "ğŸ“‹ Found existing report - creating backup..."
            BACKUP_DIR="e2e-automation/ExcelReports/Backup"
            mkdir -p "$BACKUP_DIR"
            TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
            BACKUP_FILE="TestResults_PreReset_${TIMESTAMP}.xlsx"
            cp "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx" "$BACKUP_DIR/$BACKUP_FILE"
            
            if [ -f "$BACKUP_DIR/$BACKUP_FILE" ]; then
              echo "âœ… Backup created: $BACKUP_FILE"
              rm -f "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx"
              echo "âœ… Excel report deleted - next run will create fresh report"
            else
              echo "âŒ Backup failed - aborting reset"
              exit 1
            fi
          else
            echo "â„¹ï¸  No existing report found - will create new report"
          fi
      
      - name: âš™ï¸ Configure Test Environment
        working-directory: e2e-automation
        run: |
          echo "ğŸ”§ Configuring environment-specific settings..."
          
          # Get workflow inputs with defaults
          HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
          BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'qa' }}"
          LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
          PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ ENVIRONMENT CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Environment: ${ENVIRONMENT}"
          echo "Browser: ${BROWSER}"
          echo "Headless: ${HEADLESS}"
          echo "Login Type: ${LOGIN_TYPE}"
          echo "PAMS ID: ${PAMS_ID}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Inject secrets into environment-specific config file
          ENV_FILE="src/test/resources/environments/${ENVIRONMENT}.properties"
          
          if [ -f "$ENV_FILE" ]; then
            echo "âœ… Found environment file: ${ENV_FILE}"
            
            # Update credentials from GitHub Secrets (more secure than hardcoding)
            if [ -n "${{ secrets.SSO_USERNAME }}" ]; then
              sed -i "s|^sso.username=.*|sso.username=${{ secrets.SSO_USERNAME }}|" "$ENV_FILE"
              sed -i "s|^sso.password=.*|sso.password=${{ secrets.SSO_PASSWORD }}|" "$ENV_FILE"
              echo "âœ… SSO credentials injected from secrets"
            fi
            
            if [ -n "${{ secrets.NON_SSO_USERNAME }}" ]; then
              sed -i "s|^nonsso.username=.*|nonsso.username=${{ secrets.NON_SSO_USERNAME }}|" "$ENV_FILE"
              sed -i "s|^nonsso.password=.*|nonsso.password=${{ secrets.NON_SSO_PASSWORD }}|" "$ENV_FILE"
              echo "âœ… NON-SSO credentials injected from secrets"
            fi
            
            # Update login type if overridden
            sed -i "s|^login.type=.*|login.type=${LOGIN_TYPE}|" "$ENV_FILE"
            
            # Update PAMS ID if provided
            if [ -n "${PAMS_ID}" ]; then
              sed -i "s|^pams.id=.*|pams.id=${PAMS_ID}|" "$ENV_FILE"
            fi
          else
            echo "âš ï¸ Environment file not found: ${ENV_FILE}"
            echo "Available environment files:"
            ls -la src/test/resources/environments/ || echo "No environments directory found"
          fi
          
          echo ""
          echo "âœ… Configuration complete: -Denv=${ENVIRONMENT}"
      
      - name: ğŸ–¥ï¸ Setup Display for Headless (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "ğŸ–¥ï¸  Setting up virtual display for headless execution..."
          sudo apt-get update -qq
          sudo apt-get install -y xvfb libxi6 libgbm1
          sudo Xvfb :99 -ac -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "âœ… Virtual display configured (Xvfb on :99)"
      
      - name: ğŸ”§ Configure Parallel Execution in Test Suite
        if: always()
        working-directory: e2e-automation
        run: |
          # Determine parallel execution setting
          if [ "${{ github.event_name }}" = "schedule" ]; then
            PARALLEL="false"
            TEST_SUITE="${{ env.SCHEDULED_TEST_SUITE }}"
          else
            PARALLEL="${{ github.event.inputs.parallel_execution || 'false' }}"
            TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ”§ PARALLEL EXECUTION CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test Suite: ${TEST_SUITE}"
          echo "Parallel Execution: ${PARALLEL}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Create backup of original XML (for restoration later)
          if [ -f "${TEST_SUITE}" ]; then
            cp "${TEST_SUITE}" "${TEST_SUITE}.backup"
            echo "âœ… Created backup: ${TEST_SUITE}.backup"
          else
            echo "âŒ ERROR: Test suite file not found: ${TEST_SUITE}"
            exit 1
          fi
          
          # Modify XML based on parallel execution setting
          if [ "${PARALLEL}" = "false" ]; then
            echo "ğŸ”„ Disabling parallel execution in XML..."
            # Remove parallel attribute or set it to "none"
            sed -i 's/parallel="tests"/parallel="none"/g' "${TEST_SUITE}"
            sed -i 's/parallel="methods"/parallel="none"/g' "${TEST_SUITE}"
            sed -i 's/parallel="classes"/parallel="none"/g' "${TEST_SUITE}"
            # Also set thread-count to 1 for clarity
            sed -i 's/thread-count="[0-9]*"/thread-count="1"/g' "${TEST_SUITE}"
            echo "âœ… Parallel execution DISABLED (sequential execution)"
          else
            echo "âš¡ Keeping parallel execution ENABLED (as defined in XML)"
          fi
          
          # Show the modified suite configuration
          echo ""
          echo "ğŸ“„ Current suite configuration:"
          grep -E '<suite.*parallel.*thread-count' "${TEST_SUITE}" || echo "No parallel settings found"
          echo ""
      
      - name: ğŸš€ Execute E2E Tests
        working-directory: e2e-automation
        run: |
          # Record start time
          START_TIME=$(date +%s)
          
          # Detect if this is a scheduled run or manual run
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â° SCHEDULED RUN DETECTED - Using scheduled configuration"
            TEST_SUITE="${{ env.SCHEDULED_TEST_SUITE }}"
            BROWSER="${{ env.SCHEDULED_BROWSER }}"
            ENVIRONMENT="${{ env.SCHEDULED_ENVIRONMENT }}"
            HEADLESS="${{ env.SCHEDULED_HEADLESS }}"
            PARALLEL="false"
            LOGIN_TYPE="${{ env.SCHEDULED_LOGIN_TYPE }}"
            PAMS_ID="${{ env.SCHEDULED_PAMS_ID }}"
          else
            echo "ğŸ‘¤ MANUAL RUN DETECTED - Using workflow inputs"
            TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
            BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
            ENVIRONMENT="${{ github.event.inputs.environment || 'qa' }}"
            HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
            PARALLEL="${{ github.event.inputs.parallel_execution || 'false' }}"
            LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
            PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ§ª E2E TEST EXECUTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test Suite: ${TEST_SUITE}"
          echo "Config: ${BROWSER} | ${ENVIRONMENT} | Headless: ${HEADLESS} | Parallel: ${PARALLEL}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Verify test suite file exists
          if [ ! -f "${TEST_SUITE}" ]; then
            echo "âŒ ERROR: Test suite file not found: ${TEST_SUITE}"
            echo "ğŸ“‚ Available suite files:"
            ls -la *.xml || echo "No XML files found in current directory"
            exit 1
          fi
          echo "âœ… Test suite file found: ${TEST_SUITE}"
          MVN_CMD="mvn test -DsuiteXmlFile=${TEST_SUITE}"
          
          # Add CI/CD parameters (using environment-specific config files)
          MVN_CMD="${MVN_CMD} -Denv=${ENVIRONMENT} -Dlogin.type=${LOGIN_TYPE} -Dpams.id=${PAMS_ID} -Dbrowser=${BROWSER} -Dheadless.mode=${HEADLESS}"
          
          # Add CI/CD specific Maven options
          MVN_CMD="${MVN_CMD} -Dmaven.test.failure.ignore=true -B"
          
          echo ""
          echo "ğŸš€ Executing Maven command:"
          echo "${MVN_CMD}"
          echo ""
          
          # Execute tests and capture exit code
          set +e  # Temporarily disable exit on error
          ${MVN_CMD}
          MVN_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo ""
          echo "Maven Exit Code: ${MVN_EXIT_CODE}"
          
          if [ ${MVN_EXIT_CODE} -ne 0 ]; then
            echo "âš ï¸  Maven execution completed with exit code: ${MVN_EXIT_CODE}"
          fi
          
          echo ""
          echo "âœ… Test execution completed"
          echo ""
          
          # Display execution time and quick summary
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "â±ï¸  Execution Time: ${MINUTES}m ${SECONDS}s"
          
          # Quick artifact check
          [ -f "test-output/testng-results.xml" ] && echo "âœ… TestNG results generated" || echo "âš ï¸  TestNG results missing"
          
          # Check Allure results (report is generated in next step)
          if [ -d "AllureReports/allure-results" ]; then
            RESULT_COUNT=$(find AllureReports/allure-results -type f 2>/dev/null | wc -l)
            if [ "${RESULT_COUNT}" -gt 0 ]; then
              echo "âœ… Allure results found: ${RESULT_COUNT} files"
            else
              echo "âš ï¸  Allure results directory exists but is empty"
            fi
          else
            echo "âš ï¸  Allure results directory missing"
          fi
          
          [ -d "ExcelReports" ] && echo "âœ… Excel report generated" || echo "âš ï¸  Excel report missing"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Test Validation
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo ""
          echo "ğŸ” Validating test execution..."
          
          VALIDATION_FAILED=0
          TESTNG_RESULTS=""
          [ -f "test-output/testng-results.xml" ] && TESTNG_RESULTS="test-output/testng-results.xml"
          [ -z "$TESTNG_RESULTS" ] && [ -f "target/surefire-reports/testng-results.xml" ] && TESTNG_RESULTS="target/surefire-reports/testng-results.xml"
          
          if [ -z "$TESTNG_RESULTS" ]; then
            echo "âŒ ERROR: TestNG results not found"
            VALIDATION_FAILED=1
          else
            TOTAL_TESTS=$(grep -oP 'total="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            PASSED_TESTS=$(grep -oP 'passed="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            FAILED_TESTS=$(grep -oP 'failed="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            SKIPPED_TESTS=$(grep -oP 'skipped="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            
            echo "ğŸ“Š Results: Total: ${TOTAL_TESTS} | Passed: ${PASSED_TESTS} | Failed: ${FAILED_TESTS} | Skipped: ${SKIPPED_TESTS}"
            
            if [ "$TOTAL_TESTS" = "0" ] || [ -z "$TOTAL_TESTS" ]; then
              echo "âŒ ERROR: No tests executed - check configuration"
              VALIDATION_FAILED=1
            elif [ "$FAILED_TESTS" != "0" ] && [ -n "$FAILED_TESTS" ]; then
              echo "âŒ TEST FAILURES: ${FAILED_TESTS}/${TOTAL_TESTS} failed (Pass rate: $(awk "BEGIN {printf \"%.1f%%\", (${PASSED_TESTS}/${TOTAL_TESTS})*100}"))"
              VALIDATION_FAILED=1
            else
              echo "âœ… All ${TOTAL_TESTS} test(s) PASSED"
            fi
          fi
          
          [ $VALIDATION_FAILED -eq 1 ] && exit 1 || exit 0
      
      - name: ğŸ“Š Generate Allure Report
        if: always()
        working-directory: e2e-automation
        run: |
          if [ -d "AllureReports/allure-results" ] && [ "$(ls -A AllureReports/allure-results 2>/dev/null)" ]; then
            echo "ğŸ“Š Generating Allure Report..."
            RESULTS_DIR="AllureReports/allure-results"
            REPORT_DIR="AllureReports/allure-report"
            
            # Clean previous report
            rm -rf "${REPORT_DIR}"
            
            # Generate report using Maven plugin
            mvn allure:report -B -Dallure.results.directory="${RESULTS_DIR}" -Dallure.report.directory="${REPORT_DIR}" || {
              echo "âš ï¸  Maven Allure plugin failed, trying Allure CLI..."
              # Install Allure CLI if not available
              if ! command -v allure &> /dev/null; then
                echo "ğŸ“¦ Installing Allure CLI..."
                wget -qO- https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz | tar -xz
                export PATH="$PWD/allure-2.27.0/bin:$PATH"
              fi
              
              # Generate report using Allure CLI
              allure generate "${RESULTS_DIR}" -o "${REPORT_DIR}" --clean
            }
            
            # Verify report was generated
            if [ -d "${REPORT_DIR}" ] && [ -f "${REPORT_DIR}/index.html" ]; then
              echo "âœ… Allure report generated successfully"
              echo "ğŸ“„ Report location: ${REPORT_DIR}/index.html"
            else
              echo "âŒ Allure report generation failed"
              exit 1
            fi
          else
            echo "âš ï¸  No Allure results found - skipping report generation"
          fi
      
      - name: ğŸ”„ Restore Original Test Suite XML
        if: always()
        working-directory: e2e-automation
        run: |
          # Determine which test suite was used
          if [ "${{ github.event_name }}" = "schedule" ]; then
            TEST_SUITE="${{ env.SCHEDULED_TEST_SUITE }}"
          else
            TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
          fi
          
          # Restore backup if it exists
          if [ -f "${TEST_SUITE}.backup" ]; then
            mv "${TEST_SUITE}.backup" "${TEST_SUITE}"
            echo "âœ… Restored original test suite XML: ${TEST_SUITE}"
          else
            echo "â„¹ï¸  No backup found to restore"
          fi
      
      - name: ğŸ“Š Generate Test Report Summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show trigger type
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "**Trigger:** â° Scheduled Run (Automatic)" >> $GITHUB_STEP_SUMMARY
            echo "**Test Suite:** ${{ env.SCHEDULED_TEST_SUITE }}" >> $GITHUB_STEP_SUMMARY
            echo "**Browser:** ${{ env.SCHEDULED_BROWSER }}" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ env.SCHEDULED_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
            echo "**Headless Mode:** ${{ env.SCHEDULED_HEADLESS }}" >> $GITHUB_STEP_SUMMARY
            echo "**Login Type:** ${{ env.SCHEDULED_LOGIN_TYPE }}" >> $GITHUB_STEP_SUMMARY
            echo "**PAMS ID:** ${{ env.SCHEDULED_PAMS_ID }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Trigger:** ğŸ‘¤ Manual Run" >> $GITHUB_STEP_SUMMARY
            echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Browser:** ${{ github.event.inputs.browser || 'chrome' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ github.event.inputs.environment || 'qa' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Headless Mode:** ${{ github.event.inputs.headless_mode || 'true' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Parallel Execution:** ${{ github.event.inputs.parallel_execution || 'false' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Login Type:** ${{ github.event.inputs.login_type || 'NON_SSO' }}" >> $GITHUB_STEP_SUMMARY
            echo "**PAMS ID:** ${{ github.event.inputs.pams_id || '23139' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Excel Report Reset:** ${{ github.event.inputs.reset_excel_report || 'false' }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find TestNG results file - check multiple possible locations
          TESTNG_FILE=""
          echo "ğŸ” Searching for TestNG results file..."
          
          # Check location 1: test-output
          if [ -f "e2e-automation/test-output/testng-results.xml" ]; then
            TESTNG_FILE="e2e-automation/test-output/testng-results.xml"
            echo "âœ… Found TestNG results at: test-output/testng-results.xml"
          fi
          
          # Check location 2: target/surefire-reports (Maven default)
          if [ -z "$TESTNG_FILE" ] && [ -f "e2e-automation/target/surefire-reports/testng-results.xml" ]; then
            TESTNG_FILE="e2e-automation/target/surefire-reports/testng-results.xml"
            echo "âœ… Found TestNG results at: target/surefire-reports/testng-results.xml"
          fi
          
          if [ -z "$TESTNG_FILE" ]; then
            echo "âŒ TestNG results file not found at any location"
          fi
          
          # Parse TestNG results and display test statistics
          if [ -n "$TESTNG_FILE" ]; then
            echo "## ğŸ“ˆ Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract test counts from TestNG XML - using simpler regex patterns
            PASSED=$(grep -oP 'passed="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            FAILED=$(grep -oP 'failed="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            SKIPPED=$(grep -oP 'skipped="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            TOTAL=$(grep -oP 'total="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            
            # If TOTAL is still 0 or not found, calculate it from other values
            if [ "$TOTAL" -eq 0 ] 2>/dev/null || [ -z "$TOTAL" ]; then
              TOTAL=$((PASSED + FAILED + SKIPPED))
            fi
            
            # Calculate pass rate
            if [ "$TOTAL" -gt 0 ]; then
              PASS_RATE=$(awk "BEGIN {printf \"%.1f\", ($PASSED/$TOTAL)*100}")
            else
              PASS_RATE="0.0"
            fi
            
            # Determine status emoji
            if [ "$FAILED" -eq 0 ] && [ "$PASSED" -gt 0 ]; then
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="All Tests Passed"
            elif [ "$FAILED" -gt 0 ]; then
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="Some Tests Failed"
            else
              STATUS_EMOJI="âš ï¸"
              STATUS_TEXT="No Tests Executed"
            fi
            
            echo "### ${STATUS_EMOJI} ${STATUS_TEXT}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count | Percentage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|------------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Passed** | **${PASSED}** | $(awk "BEGIN {printf \"%.1f%%\", ($PASSED/$TOTAL)*100}" 2>/dev/null || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ **Failed** | **${FAILED}** | $(awk "BEGIN {printf \"%.1f%%\", ($FAILED/$TOTAL)*100}" 2>/dev/null || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ **Skipped** | **${SKIPPED}** | $(awk "BEGIN {printf \"%.1f%%\", ($SKIPPED/$TOTAL)*100}" 2>/dev/null || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“Š **Total** | **${TOTAL}** | 100% |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pass Rate:** ${PASS_RATE}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Warning:** TestNG results file not found at expected locations." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Searched locations:" >> $GITHUB_STEP_SUMMARY
            echo "- \`e2e-automation/test-output/testng-results.xml\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`e2e-automation/target/surefire-reports/testng-results.xml\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add quick links to artifacts
          echo "## ğŸ“¦ Available Reports & Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "After the workflow completes, the following artifacts will be available for download:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š **Allure Report** - Interactive HTML test report with screenshots and environment info" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ **Excel Reports** - Comprehensive test results in Excel format" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª **TestNG Results** - Raw TestNG XML and HTML reports" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **Logs** - Detailed execution logs for debugging" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¸ **Screenshots** - Failure screenshots (if any tests failed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ğŸ’¡ **Tip:** Click on the 'Summary' tab above to download artifacts quickly!" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report_${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}_${{ github.event.inputs.browser || 'chrome' }}_${{ github.event.inputs.environment || 'qa' }}_${{ github.run_number }}_${{ github.run_attempt }}
          path: e2e-automation/AllureReports/allure-report/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ğŸ“¤ Upload TestNG Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-results_${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}_${{ github.event.inputs.browser || 'chrome' }}_${{ github.event.inputs.environment || 'qa' }}_${{ github.run_number }}_${{ github.run_attempt }}
          path: |
            e2e-automation/test-output/testng-results.xml
            e2e-automation/test-output/emailable-report.html
            e2e-automation/target/surefire-reports/testng-results.xml
            e2e-automation/target/surefire-reports/emailable-report.html
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ğŸ” Verify Excel Report Generation
        if: always()
        run: |
          echo "ğŸ” Checking Excel reports..."
          if [ -d "e2e-automation/ExcelReports" ]; then
            echo "âœ… ExcelReports directory found"
            ls -lh e2e-automation/ExcelReports/*.xlsx 2>/dev/null || echo "âš ï¸  No .xlsx files found"
          else
            echo "âŒ ExcelReports directory missing"
          fi
      
      - name: ğŸ“¤ Upload Excel Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-reports_${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}_${{ github.event.inputs.browser || 'chrome' }}_${{ github.event.inputs.environment || 'qa' }}_${{ github.run_number }}_${{ github.run_attempt }}
          path: e2e-automation/ExcelReports/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ğŸ“¤ Upload Screenshots
        if: failure() || contains(github.event.head_commit.message, 'force-screenshots')
        uses: actions/upload-artifact@v4
        with:
          name: screenshots_${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}_${{ github.event.inputs.browser || 'chrome' }}_${{ github.event.inputs.environment || 'qa' }}_${{ github.run_number }}_${{ github.run_attempt }}
          path: e2e-automation/Screenshots/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ğŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs_${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}_${{ github.event.inputs.browser || 'chrome' }}_${{ github.event.inputs.environment || 'qa' }}_${{ github.run_number }}_${{ github.run_attempt }}
          path: e2e-automation/logs/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ğŸ’¬ Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let comment = `## ğŸ§ª E2E Test Results\n\n`;
            comment += `**Status:** ${{ job.status }}\n`;
            comment += `**Browser:** ${{ github.event.inputs.browser || 'chrome' }}\n`;
            comment += `**Test Suite:** ${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}\n\n`;
            comment += `ğŸ“Š [View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not create PR comment:', error.message);
            }

