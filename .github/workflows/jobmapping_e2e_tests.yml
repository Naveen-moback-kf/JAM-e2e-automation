name: ðŸ§ª Job Mapping E2E Tests

run-name: |
  ${{ 
    github.event_name == 'schedule' && 
    'â° Scheduled Run | JAM_SmokeTestSuite.xml | chrome | qa' || 
    format('ðŸ“‹ {0} | {1} | {2}', github.event.inputs.test_suite, github.event.inputs.browser, github.event.inputs.environment)
  }}

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'ðŸ“‹ Test Suite to Execute'
        required: true
        default: 'JAM_SmokeTestSuite.xml'
        type: choice
        options:
          - JAM_SanityTestSuite.xml
          - JAM_SmokeTestSuite.xml
          - JAM_RegressionTestSuite.xml
      
      browser:
        description: 'Browser'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      
      environment:
        description: 'Test Environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - stage
          - prod-eu
          - prod-us
      
      headless_mode:
        description: 'Run in Headless Mode'
        required: true
        default: true
        type: boolean
      
      parallel_execution:
        description: 'Enable Parallel Execution'
        required: false
        default: true
        type: boolean
      
      login_type:
        description: 'Login Type'
        required: true
        default: 'NON_SSO'
        type: choice
        options:
          - SSO
          - NON_SSO
      
      pams_id:
        description: 'Target PAMS ID'
        required: false
        default: '23139'
        type: string
      
      reset_excel_report:
        description: 'ðŸ”„ Reset Excel Report'
        required: false
        default: false
        type: boolean

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.5'
  SCHEDULED_TEST_SUITE: 'JAM_SmokeTestSuite.xml'
  SCHEDULED_BROWSER: 'chrome'
  SCHEDULED_ENVIRONMENT: 'qa'
  SCHEDULED_HEADLESS: 'true'
  SCHEDULED_LOGIN_TYPE: 'NON_SSO'
  SCHEDULED_PAMS_ID: '23139'
  SCHEDULED_RESET_EXCEL: 'false'

jobs:
  e2e-tests:
    name: ðŸ§ª ${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }} (${{ github.event.inputs.browser || 'chrome' }})
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ðŸ”§ Setup Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}
      
      - name: ðŸŒ Setup Chrome Browser
        if: ${{ github.event.inputs.browser == 'chrome' }}
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: ðŸ¦Š Setup Firefox Browser
        if: ${{ github.event.inputs.browser == 'firefox' }}
        uses: browser-actions/setup-firefox@latest
        with:
          firefox-version: latest
      
      - name: ðŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: ðŸ“ Create Report Directories
        run: |
          mkdir -p e2e-automation/{AllureReports/{allure-results,allure-report},test-output/screenshots,ExcelReports,logs,src/test/resources/JobCatalogBackups}
      
      - name: ðŸ“¥ Download Previous Excel Report
        if: ${{ github.event.inputs.reset_excel_report != 'true' }}
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: jobmapping_e2e_tests.yml
          name_is_regexp: true
          name: ^excel-reports_.*
          path: e2e-automation/ExcelReports/
          if_no_artifact_found: ignore
      
      - name: ðŸ”„ Reset Excel Report
        if: ${{ github.event.inputs.reset_excel_report == 'true' }}
        run: |
          echo "ðŸ”„ Resetting Excel Report"
          if [ -f "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx" ]; then
            BACKUP_DIR="e2e-automation/ExcelReports/Backup"
            mkdir -p "$BACKUP_DIR"
            TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
            cp "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx" "$BACKUP_DIR/TestResults_PreReset_${TIMESTAMP}.xlsx"
            rm -f "e2e-automation/ExcelReports/JobMappingAutomationTestResults.xlsx"
            echo "âœ… Backup created and report deleted"
          fi
      
      - name: âš™ï¸ Configure Test Environment
        working-directory: e2e-automation
        run: |
          HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
          BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'qa' }}"
          LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
          PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          
          echo "ðŸŒ Environment: ${ENVIRONMENT} | Browser: ${BROWSER} | Headless: ${HEADLESS}"
          
          ENV_FILE="src/test/resources/environments/${ENVIRONMENT}.properties"
          
          if [ -f "$ENV_FILE" ]; then
            [ -n "${{ secrets.SSO_USERNAME }}" ] && sed -i "s|^sso.username=.*|sso.username=${{ secrets.SSO_USERNAME }}|" "$ENV_FILE"
            [ -n "${{ secrets.SSO_PASSWORD }}" ] && sed -i "s|^sso.password=.*|sso.password=${{ secrets.SSO_PASSWORD }}|" "$ENV_FILE"
            [ -n "${{ secrets.NON_SSO_USERNAME }}" ] && sed -i "s|^nonsso.username=.*|nonsso.username=${{ secrets.NON_SSO_USERNAME }}|" "$ENV_FILE"
            [ -n "${{ secrets.NON_SSO_PASSWORD }}" ] && sed -i "s|^nonsso.password=.*|nonsso.password=${{ secrets.NON_SSO_PASSWORD }}|" "$ENV_FILE"
            sed -i "s|^login.type=.*|login.type=${LOGIN_TYPE}|" "$ENV_FILE"
            [ -n "${PAMS_ID}" ] && sed -i "s|^pams.id=.*|pams.id=${PAMS_ID}|" "$ENV_FILE"
            echo "âœ… Configuration complete"
          else
            echo "âš ï¸ Environment file not found: ${ENV_FILE}"
          fi
      
      - name: ðŸ–¥ï¸ Setup Display for Headless
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y xvfb libxi6 libgbm1
          sudo Xvfb :99 -ac -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
      
      - name: ðŸ”§ Configure Parallel Execution
        working-directory: e2e-automation
        run: |
          PARALLEL="${{ github.event.inputs.parallel_execution || 'false' }}"
          TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
          
          echo "Test Suite: ${TEST_SUITE} | Parallel: ${PARALLEL}"
          
          if [ -f "${TEST_SUITE}" ]; then
            cp "${TEST_SUITE}" "${TEST_SUITE}.backup"
            
            if [ "${PARALLEL}" = "false" ]; then
              sed -i 's/parallel="tests"/parallel="none"/g; s/parallel="methods"/parallel="none"/g; s/parallel="classes"/parallel="none"/g; s/thread-count="[0-9]*"/thread-count="1"/g' "${TEST_SUITE}"
              echo "âœ… Parallel execution disabled"
            else
              echo "âœ… Parallel execution enabled"
            fi
          else
            echo "âŒ Test suite not found: ${TEST_SUITE}"
            exit 1
          fi
      
      - name: ðŸš€ Execute E2E Tests
        working-directory: e2e-automation
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
          BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'qa' }}"
          HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
          LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
          PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          
          echo "ðŸ§ª Executing: ${TEST_SUITE} | ${BROWSER} | ${ENVIRONMENT}"
          
          MVN_CMD="mvn test -DsuiteXmlFile=${TEST_SUITE} -Denv=${ENVIRONMENT} -Dlogin.type=${LOGIN_TYPE} -Dpams.id=${PAMS_ID} -Dbrowser=${BROWSER} -Dheadless.mode=${HEADLESS} -Dmaven.test.failure.ignore=true -B"
          
          set +e
          ${MVN_CMD}
          MVN_EXIT_CODE=$?
          set -e
          
          echo "Maven exit code: ${MVN_EXIT_CODE}"
          
          TESTNG_RESULTS="test-output/testng-results.xml"
          [ ! -f "$TESTNG_RESULTS" ] && TESTNG_RESULTS="target/surefire-reports/testng-results.xml"
          
          if [ -f "$TESTNG_RESULTS" ]; then
            TOTAL=$(grep -oP 'total="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            PASSED=$(grep -oP 'passed="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            FAILED=$(grep -oP 'failed="\K[^"]+' "$TESTNG_RESULTS" | head -1 || echo "0")
            echo "ðŸ“Š Total: ${TOTAL} | Passed: ${PASSED} | Failed: ${FAILED}"
            
            [ "$FAILED" != "0" ] && exit 1 || exit 0
          else
            echo "âŒ TestNG results not found"
            exit 1
          fi
      
      - name: ðŸ“Š Generate Allure Report
        if: always()
        working-directory: e2e-automation
        run: |
          if [ -d "AllureReports/allure-results" ] && [ "$(ls -A AllureReports/allure-results 2>/dev/null)" ]; then
            echo "ðŸ“Š Generating Allure Report"
            mvn allure:report -B || {
              wget -qO- https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz | tar -xz
              export PATH="$PWD/allure-2.27.0/bin:$PATH"
              allure generate AllureReports/allure-results -o AllureReports/allure-report --clean
            }
            echo "âœ… Allure report generated"
          fi
      
      - name: ðŸ”„ Restore Test Suite XML
        if: always()
        working-directory: e2e-automation
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}"
          [ -f "${TEST_SUITE}.backup" ] && mv "${TEST_SUITE}.backup" "${TEST_SUITE}"
      
      - name: ðŸ“Š Generate Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'JAM_SmokeTestSuite.xml' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ github.event.inputs.browser || 'chrome' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'qa' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TESTNG_FILE=""
          [ -f "e2e-automation/test-output/testng-results.xml" ] && TESTNG_FILE="e2e-automation/test-output/testng-results.xml"
          [ -z "$TESTNG_FILE" ] && [ -f "e2e-automation/target/surefire-reports/testng-results.xml" ] && TESTNG_FILE="e2e-automation/target/surefire-reports/testng-results.xml"
          
          if [ -n "$TESTNG_FILE" ]; then
            PASSED=$(grep -oP 'passed="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            FAILED=$(grep -oP 'failed="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            SKIPPED=$(grep -oP 'skipped="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "0")
            TOTAL=$(grep -oP 'total="\K[^"]+' "$TESTNG_FILE" | head -1 || echo "$((PASSED + FAILED + SKIPPED))")
            
            [ "$FAILED" -eq 0 ] && [ "$PASSED" -gt 0 ] && STATUS="âœ… All Tests Passed" || STATUS="âŒ Some Tests Failed"
            
            echo "### ${STATUS}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | ${PASSED} |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | ${FAILED} |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report_${{ github.run_number }}
          path: e2e-automation/AllureReports/allure-report/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ðŸ“¤ Upload TestNG Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-results_${{ github.run_number }}
          path: |
            e2e-automation/test-output/
            e2e-automation/target/surefire-reports/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ðŸ“¤ Upload Excel Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-reports_${{ github.run_number }}
          path: e2e-automation/ExcelReports/
          retention-days: 30
          if-no-files-found: ignore
      
      - name: ðŸ“¤ Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots_${{ github.run_number }}
          path: e2e-automation/Screenshots/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs_${{ github.run_number }}
          path: e2e-automation/logs/
          retention-days: 7
          if-no-files-found: warn