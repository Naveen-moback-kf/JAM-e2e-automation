name: ðŸ§ª Job Mapping E2E Tests

on:
  # Trigger on push to main branches
  push:
    branches:
      - main
      - develop
      - 'release/**'
  
  # Trigger on pull requests
  pull_request:
    branches:
      - main
      - develop
  
  # Manual trigger with parameters
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test Suite to Execute'
        required: true
        default: 'smoke_tests.xml'
        type: choice
        options:
          - smoke_tests.xml
          - regression_tests.xml
          - all_tests.xml
      
      browser:
        description: 'Browser'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      
      environment:
        description: 'Test Environment'
        required: true
        default: 'qa'
        type: choice
        options:
          - dev
          - qa
          - stage
          - prodeu
          - produs
      
      headless_mode:
        description: 'Run in Headless Mode'
        required: true
        default: true
        type: boolean
      
      parallel_execution:
        description: 'Enable Parallel Execution'
        required: false
        default: false
        type: boolean
      
      login_type:
        description: 'Login Type'
        required: true
        default: 'NON_SSO'
        type: choice
        options:
          - SSO
          - NON_SSO
      
      pams_id:
        description: 'Target PAMS ID (leave empty to verify all clients)'
        required: false
        default: '23139'
        type: string
  
  # Schedule: Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.5'

jobs:
  e2e-tests:
    name: ðŸ§ª E2E Tests (${{ github.event.inputs.browser || 'chrome' }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # For parallel browser testing
        browser: [chrome]  # Add firefox, edge for multi-browser testing
      fail-fast: false
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: ðŸ”§ Setup Maven
        uses: stCarolas/setup-maven@v4.5
        with:
          maven-version: ${{ env.MAVEN_VERSION }}
      
      - name: ðŸŒ Setup Chrome Browser
        if: ${{ github.event.inputs.browser == 'chrome' || matrix.browser == 'chrome' }}
        uses: browser-actions/setup-chrome@latest
        with:
          chrome-version: stable
      
      - name: ðŸ¦Š Setup Firefox Browser
        if: ${{ github.event.inputs.browser == 'firefox' || matrix.browser == 'firefox' }}
        uses: browser-actions/setup-firefox@latest
        with:
          firefox-version: latest
      
      - name: ðŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      - name: ðŸ§¹ Clean Previous Build
        working-directory: e2e-automation
        run: mvn clean
      
      - name: ðŸ“ Create Report Directories
        run: |
          mkdir -p e2e-automation/test-output/ExtentReports
          mkdir -p e2e-automation/test-output/screenshots
          mkdir -p e2e-automation/ExcelReports
          mkdir -p e2e-automation/logs
          mkdir -p e2e-automation/JobCatalogBackups
      
      - name: âš™ï¸ Configure Test Environment
        working-directory: e2e-automation
        run: |
          echo "ðŸ”§ Creating config.properties from template..."
          
          # Copy template to config.properties
          cp src/test/resources/config.properties.template src/test/resources/config.properties
          
          # Configure from workflow inputs
          HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
          BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'Dev' }}"
          LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
          PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          
          # Update basic settings
          sed -i "s/^headless\.mode=.*/headless.mode=${HEADLESS}/" src/test/resources/config.properties
          sed -i "s/^browser=.*/browser=${BROWSER}/" src/test/resources/config.properties
          sed -i "s/^Environment=.*/Environment=${ENVIRONMENT}/" src/test/resources/config.properties
          sed -i "s/^login\.type=.*/login.type=${LOGIN_TYPE}/" src/test/resources/config.properties
          sed -i "s/^target\.pams\.id=.*/target.pams.id=${PAMS_ID}/" src/test/resources/config.properties
          
          # Inject credentials from GitHub Secrets
          echo "ðŸ” Injecting credentials from GitHub Secrets..."
          sed -i "s/\${SSO_USERNAME}/${{ secrets.SSO_USERNAME }}/" src/test/resources/config.properties
          sed -i "s/\${SSO_PASSWORD}/${{ secrets.SSO_PASSWORD }}/" src/test/resources/config.properties
          sed -i "s/\${NON_SSO_USERNAME}/${{ secrets.NON_SSO_USERNAME }}/" src/test/resources/config.properties
          sed -i "s/\${NON_SSO_PASSWORD}/${{ secrets.NON_SSO_PASSWORD }}/" src/test/resources/config.properties
          
          echo "âœ… config.properties created and configured"
          echo "ðŸ“‹ Configuration Summary:"
          echo "   Browser: ${BROWSER}"
          echo "   Environment: ${ENVIRONMENT}"
          echo "   Headless: ${HEADLESS}"
          echo "   Login Type: ${LOGIN_TYPE}"
          echo "   PAMS ID: ${PAMS_ID}"
      
      - name: ðŸ–¥ï¸ Setup Display for Headless (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "ðŸ–¥ï¸  Setting up virtual display for headless execution..."
          sudo apt-get update -qq
          sudo apt-get install -y xvfb libxi6 libgbm1
          sudo Xvfb :99 -ac -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "âœ… Virtual display configured (Xvfb on :99)"
      
      - name: ðŸš€ Execute E2E Tests
        working-directory: e2e-automation
        run: |
          TEST_SUITE="${{ github.event.inputs.test_suite || 'smoke_tests.xml' }}"
          BROWSER="${{ github.event.inputs.browser || 'chrome' }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'qa' }}"
          HEADLESS="${{ github.event.inputs.headless_mode || 'true' }}"
          PARALLEL="${{ github.event.inputs.parallel_execution || 'false' }}"
          LOGIN_TYPE="${{ github.event.inputs.login_type || 'NON_SSO' }}"
          PAMS_ID="${{ github.event.inputs.pams_id || '23139' }}"
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "    E2E TEST EXECUTION CONFIGURATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Test Suite: ${TEST_SUITE}"
          echo "Browser: ${BROWSER}"
          echo "Environment: ${ENVIRONMENT}"
          echo "Login Type: ${LOGIN_TYPE}"
          echo "PAMS ID: ${PAMS_ID}"
          echo "Headless Mode: ${HEADLESS}"
          echo "Parallel Execution: ${PARALLEL}"
          echo "Working Directory: $(pwd)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Verify test suite file exists
          if [ ! -f "${TEST_SUITE}" ]; then
            echo "âŒ ERROR: Test suite file not found: ${TEST_SUITE}"
            echo "ðŸ“‚ Available suite files:"
            ls -la *.xml || echo "No XML files found in current directory"
            exit 1
          fi
          echo "âœ… Test suite file found: ${TEST_SUITE}"
          
          # Build Maven command
          MVN_CMD="mvn test -DsuiteXmlFile=${TEST_SUITE}"
          
          # Add browser parameter (if needed by your framework)
          # MVN_CMD="${MVN_CMD} -Dbrowser=${BROWSER}"
          
          # Add environment parameter (if needed by your framework)
          # MVN_CMD="${MVN_CMD} -Denvironment=${ENVIRONMENT}"
          
          # Add parallel execution if enabled
          if [ "${PARALLEL}" = "true" ]; then
            MVN_CMD="${MVN_CMD} -Dparallel=methods -DthreadCount=3"
            echo "âš¡ Parallel execution enabled (3 threads)"
          fi
          
          # Add CI/CD specific Maven options
          MVN_CMD="${MVN_CMD} -Dmaven.test.failure.ignore=true -B"
          
          echo ""
          echo "ðŸš€ Executing Maven command:"
          echo "${MVN_CMD}"
          echo ""
          
          # Execute tests (continue on failure to generate reports)
          ${MVN_CMD} || {
            echo "âš ï¸  Tests completed with failures (this is expected, reports will be generated)"
            EXIT_CODE=$?
          }
          
          echo ""
          echo "âœ… Test execution completed"
          echo ""
          
          # Display summary
          if [ -f "test-output/testng-results.xml" ]; then
            echo "ðŸ“Š TestNG results file generated successfully"
          else
            echo "âš ï¸  TestNG results file not found"
          fi
          
          if [ -d "test-output/ExtentReports" ]; then
            echo "ðŸ“ˆ ExtentReports directory exists"
            ls -la test-output/ExtentReports/ || echo "ExtentReports directory is empty"
          else
            echo "âš ï¸  ExtentReports directory not found"
          fi
      
      - name: ðŸ“Š Generate Test Report Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'smoke_tests.xml' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ github.event.inputs.browser || 'chrome' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'qa' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Headless Mode:** ${{ github.event.inputs.headless_mode || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‚ **Reports Available:** ExtentReports, Excel Reports, Screenshots" >> $GITHUB_STEP_SUMMARY
      
      - name: ðŸ“¤ Upload Extent Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: extent-report-${{ matrix.browser }}
          path: e2e-automation/test-output/ExtentReports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload TestNG Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testng-results-${{ matrix.browser }}
          path: |
            e2e-automation/test-output/testng-results.xml
            e2e-automation/test-output/emailable-report.html
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload Excel Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: excel-reports-${{ matrix.browser }}
          path: e2e-automation/ExcelReports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: e2e-automation/test-output/screenshots/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: ðŸ“¤ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.browser }}
          path: e2e-automation/logs/
          retention-days: 7
          if-no-files-found: warn
      
      - name: ðŸ’¬ Comment PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let comment = `## ðŸ§ª E2E Test Results\n\n`;
            comment += `**Status:** ${{ job.status }}\n`;
            comment += `**Browser:** ${{ github.event.inputs.browser || 'chrome' }}\n`;
            comment += `**Test Suite:** ${{ github.event.inputs.test_suite || 'smoke_tests.xml' }}\n\n`;
            comment += `ðŸ“Š [View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})\n`;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not create PR comment:', error.message);
            }

